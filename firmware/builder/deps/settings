#!/bin/sh

API_VERSION=$(cat ../version)
NEST_CONFIG_DIR="/etc/nestlabs"
TARGET_FILE="$NEST_CONFIG_DIR/client.config"
BACKUP_FILE="$NEST_CONFIG_DIR/client.config.old"
CREDFILE="/media/user-config/settings.config"
DEVICE_NAME=$(hostname)
API_KEY=$(cat $NEST_CONFIG_DIR/apikey.txt)
LOGDIR=/var/log
LOGFILE=$LOGDIR/nle-api.log
HTTP_RETURN_CODE=
CURRENT_SCHEME=
CURRENT_URL=
CURRENT_SERVER=
NEW_SCHEME=
NEW_URL=
NEW_SERVER=
log_writer() {
  logger "$(date '+%m/%d/%Y %H:%M:%S') - $1" #>> /dev/null #${LOGFILE}
}
get_cloudregisterurl() {
  CURRENT_URL=$(cat $TARGET_FILE | grep "cloudregisterurl" | busybox2 sed -n 's/.*value="\([^"]*\)".*/\1/p')
  CURRENT_SCHEME="${CURRENT_URL%%://*}"
  CURRENT_SERVER="${CURRENT_URL#*://}"
  CURRENT_SERVER="${CURRENT_SERVER%/entry}"
  log_writer "     Url : $CURRENT_URL"
  log_writer "  Scheme : $CURRENT_SCHEME"
  log_writer "  Server : $CURRENT_SERVER"
}
valid_ip_port() {
  local ip=${1:-NO_IP_PROVIDED}
  local port=$(echo "$ip" | busybox2 sed -n 's/.*:\([0-9]\+\)$/\1/p')
  ip=$(echo "$ip" | busybox2 sed 's/:.*//')
  o1=$(echo "$ip" | busybox2 cut -d. -f1)
  o2=$(echo "$ip" | busybox2 cut -d. -f2)
  o3=$(echo "$ip" | busybox2 cut -d. -f3)
  o4=$(echo "$ip" | busybox2 cut -d. -f4)
  [[ ${o1} -gt 255 || ${o2} -gt 255 || ${o3} -gt 255 || ${o4} -gt 255 ]] && return 1
  if [ -n "$port" ]; then
    [[ ${port} -lt 1 || ${port} -gt 65535 ]] && return 1
  fi
  return 0
}
check_for_api_key() {
 if [[ -z "${API_KEY}" ]]; then
  log_writer "Missing API key file. Creating it."
  local secret=$(grep 'assigned_cred_secret' ${CREDFILE} | busybox2 sed -n 's/.*value="\([^"]*\)".*/\1/p')
  if [[ -z "${secret}" ]]; then
    secret="${DEVICE_NAME}"
  fi
  echo "${secret}" > ${NEST_CONFIG_DIR}/apikey.txt
  API_KEY=$(cat $NEST_CONFIG_DIR/apikey.txt)
 fi
}
return_response() {
  local http_status="400 Bad Request"
  local http_output=`printf '%s' "$2"`
  local content_length=$(printf '%s' "$http_output" | busybox2 wc -c)
  if [[ "$1" -eq "200" ]]; then
    http_status="200 Ok"
  elif [[ "$1" -eq "401" ]]; then
    http_status="401 Unauthorized"
  fi
  log_writer "Status: $http_status"
  printf 'HTTP/1.1 %s\r\n' "$http_status"
  printf 'Content-Type: application/json\r\n'
  printf 'Content-Length: %s\r\n' "$content_length"
  printf 'Connection: Close\r\n'
  printf 'X-API-VERSION: %s\r\n' "$API_VERSION"
  printf '\r\n'
  printf '%s' "$http_output"
  log_writer ""
  log_writer ""
  exit 0
}
check_for_api_key
log_writer "Received a $REQUEST_METHOD request."
RAW_BODY="$(cat)"
RAW_BODY="${RAW_BODY// /}"
log_writer "$RAW_BODY"
if [[ ! -f $TARGET_FILE ]]; then
  STATUS="Target file does not exist. $TARGET_FILE"
  HTTP_OUTPUT=`printf '{"status":"%s"}' "$STATUS"`
  return_response "400" "$HTTP_OUTPUT"
else
  log_writer "Get existing cloudregisterurl."
  get_cloudregisterurl
fi
if [[ "$REQUEST_METHOD" == "POST" ]]; then
  INITIALIZEID=$(printf '%s\n' "$RAW_BODY" | busybox2 sed -n 's/.*"initialize":"\([^"]*\)".*/\1/p')
  if [[ -n "$INITIALIZEID" ]]; then                                                                
    if [[ "$DEVICE_NAME" == "$INITIALIZEID" ]]; then                                               
      HTTP_OUTPUT=`printf '{"api_key":"%s"}' "$API_KEY"`             
      return_response "200" "$HTTP_OUTPUT"                                                         
    fi                                                                                             
  fi

  API_TOKEN=$(printf '%s\n' "$RAW_BODY" | busybox2 sed -n 's/.*"api_key":"\([^"]*\)".*/\1/p')
  log_writer "$API_TOKEN"
  log_writer "Validate API Key."
  if [[ "$API_TOKEN" != "$API_KEY" ]]; then
    log_writer "Invalid or missing API Key."
    HTTP_OUTPUT=`printf '{"status":"%s"}' "Invalid or Missing API Key."`
    return_response "401" "$HTTP_OUTPUT"
  fi
  log_writer "Get the new endpoint."
  NEW_URL=$(printf '%s\n' "$RAW_BODY" | busybox2 sed -n 's/.*"endpoint":"\([^"]*\)".*/\1/p')
  NEW_PORT=
  if [[ -n "$NEW_URL" ]]; then
    NEW_SCHEME="${NEW_URL%%://*}"
    NEW_SERVER="${NEW_URL#*://}"
    if valid_ip_port "$NEW_SERVER"; then
      log_writer "Valid IP address/port. $NEW_SERVER"
      log_writer "Creating backup of existing."
      log_writer "  from : $TARGET_FILE"
      log_writer "    to : $BACKUP_FILE"
      cp $TARGET_FILE $BACKUP_FILE
      NEW_URL="$NEW_URL/entry"
      log_writer "Replace existing url with new url."
      busybox2 sed -i 's|<a key="cloudregisterurl" value="[^"]*"|<a key="cloudregisterurl" value="'$NEW_URL'"|g' $TARGET_FILE
      log_writer "Get new cloudregisterurl."
      get_cloudregisterurl
      sleep 10 && /etc/init.d/nestlabs restart &
      STATUS=`printf '{"device_name":"%s","status":"%s","cloudregisterurl":"%s"}' $DEVICE_NAME "new" $NEW_URL`
      HTTP_RETURN_CODE="200"
    else
      log_writer "Invalid IP address/port. $NEW_SERVER"
      STATUS=`printf '{"status":"%s"}' "Invalid IP Address/Port."`
    fi
  fi
elif [[ "$REQUEST_METHOD" == "GET" ]]; then
  if [[ -n $CURRENT_SCHEME && -n $CURRENT_SERVER ]]; then
    STATUS=`printf '{"cloudregisterurl":"%s"}' $CURRENT_URL`
    HTTP_RETURN_CODE="200"
  fi
fi
return_response "$HTTP_RETURN_CODE" "$STATUS"